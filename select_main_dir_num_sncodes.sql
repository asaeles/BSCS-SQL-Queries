/* Formatted on 2009/12/06 12:23 (Formatter Plus v4.8.7) */
SELECT DISTINCT sncode
           FROM contr_services_cap
          WHERE cs_deactiv_date IS NULL AND main_dirnum = 'X';

SELECT *
  FROM mpusntab
 WHERE sncode IN (1, 26, 27, 120);

SELECT *
  FROM contr_services_cap
 WHERE cs_deactiv_date IS NULL AND main_dirnum = 'X' AND sncode = 26;

SELECT   tm.tmcode, tm.des, sp.spcode, sp.des,
         DECODE (cs2.co_id,
                 NULL, 'No',
                 SUBSTR (cs2.cs_stat_chng, -1)
                ) has_tel, cs.*
    FROM contr_services cs, mputmtab tm, mpusptab sp, contr_services cs2
   WHERE cs.co_id IN
            (32779708,
             32708730,
             33354118,
             34642382,
             34642415,
             34770264,
             35021294,
             34893912,
             35511534,
             35888130,
             37552656,
             38024450,
             38478236,
             39096845,
             39101117,
             39097117,
             39289524,
             39289540,
             39923157,
             40160795,
             40328432,
             40392569,
             42442780,
             42170819,
             42170831,
             42170900,
             43808869,
             44173228,
             44981610,
             45131615,
             46876833,
             47047896,
             46876737,
             47036424,
             47105022,
             47105041,
             47526859,
             47526719,
             47526721,
             47526731,
             47526732,
             47526736,
             47526739,
             47526740,
             47526746,
             47526750,
             47526752,
             47526767,
             47526808,
             47526810,
             47526812,
             47526814,
             47526828,
             47526849,
             47539771,
             47532164
            )
     AND cs.sncode = 120
     AND tm.tmcode = cs.tmcode
     AND sp.spcode = cs.spcode
     AND tm.vscode = 0
     AND cs.cs_seqno = (SELECT MAX (cs_seqno)
                          FROM contr_services
                         WHERE co_id = cs.co_id)
     AND cs2.co_id(+) = cs.co_id
     AND cs2.cs_seqno(+) = cs.cs_seqno
     AND cs2.sncode(+) = 1
ORDER BY 1, 3;

SELECT   tm.tmcode, tm.des, sp.spcode, sp.des,
         DECODE (cs2.co_id,
                 NULL, 'No',
                 SUBSTR (cs2.cs_stat_chng, -1)
                ) has_tel, cs.*
    FROM contr_services cs, mputmtab tm, mpusptab sp, contr_services cs2
   WHERE cs.sncode = 26
     AND tm.tmcode = cs.tmcode
     AND sp.spcode = cs.spcode
     AND tm.vscode = 0
     AND cs.cs_seqno = (SELECT MAX (cs_seqno)
                          FROM contr_services
                         WHERE co_id = cs.co_id)
     AND cs2.co_id(+) = cs.co_id
     AND cs2.cs_seqno(+) = cs.cs_seqno
     AND cs2.sncode(+) = 27
     AND cs.co_id IN
            (3681388,
             3694811,
             3716484,
             4355725,
             4452575,
             5685474,
             5799199,
             6098179,
             6742996,
             7011731,
             7136286,
             7137803,
             7140003,
             7148485,
             7149128,
             7185795,
             7185874,
             7229107,
             7309521,
             7351863,
             7351866,
             8143582,
             8143585,
             8143586,
             8143587,
             8143589,
             8143592,
             8147705,
             8148000,
             8153991,
             8171840,
             8172648,
             8172649,
             8172877,
             8173134,
             8173145,
             8199741,
             8199787,
             8242662,
             8499050,
             8609869,
             8656650,
             8834692,
             9016890,
             9040728,
             9237383,
             10003663,
             10099404,
             10495600,
             10956536,
             11090866,
             11091267,
             11091682,
             11224984,
             11225052,
             11281885,
             11281886,
             11281887,
             11282084,
             11282669,
             11284128,
             11284240,
             11320625,
             11320631,
             11379349,
             11380574,
             11382403,
             11538666,
             11539239,
             11539240,
             11946950,
             12045162,
             12094065,
             12096375,
             12150087,
             12197831,
             12354648,
             12355003,
             12368587,
             12649101,
             13051470,
             13540793,
             14029954,
             14299171,
             14438142,
             14761563,
             14818888,
             14989403,
             15145225,
             15159070,
             15159892,
             15244845,
             15326860,
             15396498,
             15623376,
             15652002,
             15672207,
             15997957,
             16016885,
             16175001,
             16178471,
             16330521,
             16702737,
             16985811,
             17193822,
             17444833,
             17449907,
             17455436,
             17490273,
             17756232,
             17874485,
             18190728,
             18207682,
             18284294,
             18579389,
             18602868,
             18618492,
             18621691,
             18918501,
             19013030,
             19111010,
             19126714,
             19217518,
             20212858,
             20251397,
             20251837,
             20369567,
             20369653,
             20369722,
             20369790,
             20369893,
             20369993,
             20370107,
             20370263,
             20370367,
             20370450,
             20461450,
             20735008,
             20980464,
             21082189,
             21173496,
             21355338,
             21448241,
             21789434,
             21816601,
             22077043,
             22174647,
             22276015,
             22276280,
             22449210,
             22449942,
             22502536,
             22504002,
             22585086,
             22695238,
             22773594,
             22779222,
             22947154,
             23105643,
             23324044,
             23508360,
             23587415,
             23691247,
             23824810,
             23824811,
             23824910,
             23825516,
             23969504,
             23996968,
             23996969,
             23996971,
             23996974,
             24018037,
             24098474,
             24098475,
             24098458,
             24479462,
             24652201,
             24652552,
             24652553,
             24836624,
             24837327,
             25213688,
             25215053,
             25293569,
             26277153,
             26277714,
             26565538,
             26565596,
             26893155,
             27197289,
             26987715,
             27049669,
             27049540,
             27262656,
             27249699,
             26989055,
             27250920,
             27365884,
             27418837,
             27363566,
             27451472,
             27503458,
             27626658,
             27629347,
             27629349,
             27630150,
             27631794,
             28093680,
             28199973,
             28199838,
             28199839,
             28777618,
             28869674,
             29177882,
             29523918,
             29524547,
             29708359,
             29879936,
             29878659,
             29878661,
             29882541,
             29882547,
             29882551,
             30018909,
             29948833,
             30273865,
             30272882,
             30273337,
             30781790,
             30872298,
             31240041,
             31393381,
             31529484,
             31614315,
             31619549,
             31615165,
             31701198,
             31843564,
             31946760,
             32707680,
             31975451,
             32554828,
             32554899,
             32554909,
             32554911,
             32554822,
             32779705,
             33084172,
             33354955,
             33460129,
             33178023,
             33178025,
             33858456,
             34519205,
             34770685,
             35186511,
             35186515,
             35233598,
             35511879,
             35693708,
             35744778,
             36553776,
             36584286,
             37265935,
             37266030,
             37457590,
             37457593,
             37547052,
             37366330,
             37550806,
             37457496,
             37551358,
             38291396,
             38108045,
             38291916,
             38385916,
             38385918,
             38385927,
             38512443,
             38754460,
             38755998,
             39562088,
             39364038,
             39656611,
             39472730,
             39561769,
             39975571,
             39975498,
             40098421,
             40162017,
             40162022,
             40160793,
             40161791,
             40161794,
             40161796,
             40161799,
             40161802,
             40161806,
             40161808,
             40291726,
             40909715,
             41570777,
             41631962,
             41584490,
             43403228,
             43171261,
             43172053,
             43446442,
             43661572,
             43679699,
             43961289,
             45478778,
             45224503,
             45346548,
             45347459,
             45742049,
             46188282,
             46377123,
             46372548,
             46875233,
             46875143,
             46875999,
             46956865,
             47259833,
             47634353,
             47837057
            )
ORDER BY 1, 3;

SELECT   *
    FROM mputmtab tm
   WHERE tm.vscode = (SELECT MAX (vscode)
                        FROM mputmtab
                       WHERE tmcode = tm.tmcode)
     AND NOT EXISTS (
                SELECT *
                  FROM mpulktmb
                 WHERE tmcode = tm.tmcode AND vscode = tm.vscode
                       AND sncode = 1)
     AND tm.tmcode NOT IN (74, 92)
     AND EXISTS (
               SELECT *
                 FROM mpulktmb
                WHERE tmcode = tm.tmcode AND vscode = tm.vscode
                      AND sncode = 26)
     AND NOT EXISTS (
               SELECT *
                 FROM mpulktmb
                WHERE tmcode = tm.tmcode AND vscode = tm.vscode
                      AND sncode = 27)
ORDER BY des;

SELECT   cs.tmcode, cs.spcode, cs.sncode, SUBSTR (cs.cs_stat_chng, -1),
         COUNT (*)
    FROM contr_services cs
   WHERE (   cs.sncode = 1
          OR (cs.sncode = 27 AND cs.tmcode IN (59, 93, 97, 87, 108, 109, 54)
             )
         )
     AND SUBSTR (cs.cs_stat_chng, -1) IN ('a', 's')
     AND cs.tmcode <> 20
GROUP BY cs.tmcode, cs.spcode, cs.sncode, SUBSTR (cs.cs_stat_chng, -1);
